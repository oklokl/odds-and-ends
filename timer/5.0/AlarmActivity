package com.krdonon.timer.alarm

import android.app.Activity
import android.app.KeyguardManager
import android.os.Build
import android.os.Bundle
import android.view.View
import android.view.WindowManager
import android.widget.SeekBar
import android.widget.TextView
import com.krdonon.timer.R

class AlarmActivity : Activity() {

    private lateinit var alarmTitle: TextView
    private lateinit var alarmLabel: TextView
    private lateinit var sliderDismiss: SeekBar

    private val DISMISS_THRESHOLD = 95

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // 1) 잠금 화면 위 표시 + 화면 켜기 (API 레벨별 안전 처리)
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {
            setShowWhenLocked(true)
            setTurnScreenOn(true)
            // 가능하면 키가드(잠금화면) 해제 요청
            val kg = getSystemService(KeyguardManager::class.java)
            kg?.requestDismissKeyguard(this, null)
        } else {
            @Suppress("DEPRECATION")
            window.addFlags(
                WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED or
                        WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON or
                        WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD
            )
        }

        // 2) 노치(디스플레이 컷아웃) 영역 사용: API 28+
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
            window.attributes = window.attributes.apply {
                layoutInDisplayCutoutMode =
                    WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES
            }
        }

        // 3) 알람 표시 동안 화면 꺼지지 않도록 유지
        window.addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON)

        setContentView(R.layout.activity_alarm)

        // 4) 풀스크린(상/하단 바 숨김) - 몰입 모드
        enterImmersiveMode()

        // 5) 뷰 바인딩
        alarmTitle = findViewById(R.id.alarmTitle)
        alarmLabel = findViewById(R.id.alarmLabel)
        sliderDismiss = findViewById(R.id.sliderDismiss)

        val label = intent.getStringExtra(AlarmService.EXTRA_LABEL)
            ?: getString(R.string.timer_default)
        alarmLabel.text = label

        // 6) 슬라이더로 해제
        sliderDismiss.progress = 0
        sliderDismiss.setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
            override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                if (fromUser && progress >= DISMISS_THRESHOLD) {
                    dismissAlarm()
                }
            }

            override fun onStartTrackingTouch(seekBar: SeekBar?) {}
            override fun onStopTrackingTouch(seekBar: SeekBar?) {
                if ((seekBar?.progress ?: 0) < DISMISS_THRESHOLD) {
                    seekBar?.progress = 0
                }
            }
        })
    }

    // 시스템 바를 숨기는 몰입 모드 (minSdk 26이므로 legacy API 사용 OK)
    private fun enterImmersiveMode() {
        @Suppress("DEPRECATION")
        window.decorView.systemUiVisibility =
            (View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                    or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                    or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                    or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                    or View.SYSTEM_UI_FLAG_FULLSCREEN
                    or View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY)
    }

    private fun dismissAlarm() {
        // 알람 사운드/서비스 종료 (잠금 상태에서도 확실히 중지되도록 applicationContext 사용)
        AlarmService.stop(applicationContext)

        // UI 리셋 및 종료
        if (this::sliderDismiss.isInitialized) sliderDismiss.progress = 0
        finishAndRemoveTask() // minSdk 26이므로 바로 사용 가능
    }

    // 포커스가 돌아올 때 몰입 모드 유지
    override fun onWindowFocusChanged(hasFocus: Boolean) {
        super.onWindowFocusChanged(hasFocus)
        if (hasFocus) enterImmersiveMode()
    }
}
